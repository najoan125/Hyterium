<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName hyfata.kr
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/hyfata.kr/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/hyfata.kr/privkey.pem
    LimitRequestBody 0

    <Directory /var/www/html>
        RewriteEngine On
        # 요청된 파일명이나 디렉토리가 실제로 존재하면 그대로 사용합니다.
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        # 위 조건에 해당하지 않는 모든 요청은 index.html로 보냅니다.
        RewriteRule ^ /index.html [L]
    </Directory>

    # hytube
    <Directory /var/www/html/hytube>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # uploads 디렉토리 (원본 파일, 웹에서 직접 접근 불가능하게 설정)
    <Directory /var/www/html/hytube/uploads>
        Require all denied
    </Directory>

    # streams 디렉토리 (스트리밍 파일, 웹에서 직접 접근 가능하게 설정)
    <Directory /var/www/html/hytube/streams>
        Options Indexes FollowSymLinks
        Require all granted
        # HLS/DASH MIME 타입 추가 (필요 시)
        AddType application/vnd.apple.mpegurl .m3u8
        AddType video/mp2t .ts
        AddType application/dash+xml .mpd
        # CORS 헤더 (JavaScript 플레이어에서 스트림 요청 시 필요)
        Header set Access-Control-Allow-Origin "*"
    </Directory>

    # ===== Hyterium Notion Clone Configuration =====

    # Enable necessary modules for WebSocket and proxying
    # Make sure these modules are enabled:
    # a2enmod proxy proxy_http proxy_wstunnel headers rewrite

    # Preserve original host header
    ProxyPreserveHost On

    # Request header rewriting for WebSocket
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    # IMPORTANT: Order matters! More specific paths must come first

    # 1. WebSocket handling for SockJS (must come before general API proxy)
    # This handles all WebSocket upgrade requests
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule ^/hyterium/api/ws/(.*)$ ws://localhost:9000/hyterium/api/ws/$1 [P,L]

    # 2. SockJS fallback transports (XHR streaming, polling, etc.)
    # These are regular HTTP requests that need special handling
    <Location "/hyterium/api/ws">
        ProxyPass http://localhost:9000/hyterium/api/ws
        ProxyPassReverse http://localhost:9000/hyterium/api/ws

        # Important headers for SockJS
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Credentials "true"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header set Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization"

        # Disable buffering for streaming
        ProxyBufferSize 0
        ProxyBadHeader Ignore
    </Location>

    # 3. Backend API Proxy (general API endpoints)
    ProxyPass /hyterium/api http://localhost:9000/hyterium/api
    ProxyPassReverse /hyterium/api http://localhost:9000/hyterium/api

    # 4. Frontend (Next.js)
    ProxyPass /hyterium http://localhost:3020/hyterium
    ProxyPassReverse /hyterium http://localhost:3020/hyterium

    # Additional headers for CORS and security
    <Location "/hyterium/api">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        Header set Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization"
        Header set Access-Control-Max-Age "3600"
    </Location>

</VirtualHost>
</IfModule>