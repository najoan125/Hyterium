# Apache Virtual Host Configuration for Notion Clone
# Place this file in /etc/apache2/sites-available/ or /etc/httpd/conf.d/
# Enable required modules: a2enmod proxy proxy_http proxy_wstunnel rewrite headers ssl

<VirtualHost *:80>
    ServerName hyfata.kr

    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName hyfata.kr

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/your-certificate.crt
    SSLCertificateKeyFile /etc/ssl/private/your-private-key.key
    SSLCertificateChainFile /etc/ssl/certs/your-chain.crt

    # SSL Security Settings
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/notion-clone-error.log
    CustomLog ${APACHE_LOG_DIR}/notion-clone-access.log combined

    # Enable proxy modules
    ProxyPreserveHost On
    ProxyRequests Off

    # Backend API Proxy Configuration
    # Route /hyterium/api to backend container on port 8080
    ProxyPass /hyterium/api http://localhost:8080/hyterium/api
    ProxyPassReverse /hyterium/api http://localhost:8080/hyterium/api

    # WebSocket Proxy Configuration for backend
    # Enable WebSocket support for STOMP
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /hyterium/api/ws/(.*) ws://localhost:8080/hyterium/api/ws/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /hyterium/api/ws/(.*) http://localhost:8080/hyterium/api/ws/$1 [P,L]

    # Frontend Proxy Configuration
    # Route /hyterium to frontend container on port 3000
    ProxyPass /hyterium http://localhost:3000/hyterium
    ProxyPassReverse /hyterium http://localhost:3000/hyterium

    # WebSocket Proxy for Next.js Hot Module Replacement (HMR)
    # Only needed in development, can be removed in production
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /hyterium/_next/webpack-hmr ws://localhost:3000/hyterium/_next/webpack-hmr [P,L]

    # Proxy Headers for both frontend and backend
    <Proxy *>
        Order allow,deny
        Allow from all
    </Proxy>

    # Set headers for proxied requests
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    ProxyAddHeaders On

    # Handle OPTIONS requests for CORS preflight
    <Location /hyterium/api>
        Header always set Access-Control-Allow-Origin "https://hyfata.kr"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header always set Access-Control-Allow-Credentials "true"
    </Location>

    # Optional: Root redirect
    # Uncomment if you want to redirect root to /hyterium
    # RedirectMatch ^/$ /hyterium

</VirtualHost>
